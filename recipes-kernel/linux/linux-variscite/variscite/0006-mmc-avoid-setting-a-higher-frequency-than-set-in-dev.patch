From 669e0cbed1a27c621746ed3407eb959cbe4642ca Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@googlemail.com>
Date: Thu, 13 Nov 2014 13:24:49 +0100
Subject: [PATCH 6/8] mmc: avoid setting a higher frequency than set in
 devicetree
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

taken from git://github.com/varigit/linux-2.6-imx.git branch imx_3.10.17_1.0.0_ga_beta_var2

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@googlemail.com>
---
 drivers/mmc/host/sdhci.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index beb3fc9..e377bc6 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -1140,11 +1140,20 @@ static void sdhci_set_clock(struct sdhci_host *host, unsigned int clock)
 	u16 clk = 0;
 	unsigned long timeout;
 
+
 	if (clock && clock == host->clock)
 		return;
 
 	host->mmc->actual_clock = 0;
 
+        //Check if the dts file set a max-frequency property which is lower than standard 
+        if (host->ops->get_max_clock) {
+ 	     unsigned int max_freq=0;	
+            max_freq=host->ops->get_max_clock(host);
+            if (max_freq && (max_freq < clock))
+                 clock=max_freq;
+            printk(KERN_DEBUG "clock set to %d\n",clock);
+		}
 	if (host->ops->set_clock) {
 		host->ops->set_clock(host, clock);
 		if (host->quirks & SDHCI_QUIRK_NONSTANDARD_CLOCK)
-- 
1.8.3.1

