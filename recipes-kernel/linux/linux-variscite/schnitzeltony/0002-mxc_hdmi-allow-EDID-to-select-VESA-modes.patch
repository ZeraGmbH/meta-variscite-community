From 54077a3f8ee47a0d691903fe978e53de45049c38 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@googlemail.com>
Date: Thu, 6 Nov 2014 18:29:59 +0100
Subject: [PATCH 2/3] mxc_hdmi: allow EDID to select VESA modes
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@googlemail.com>
---
 drivers/video/mxc/mxc_edid.c | 13 +++++++++++++
 drivers/video/mxc/mxc_hdmi.c |  2 +-
 include/video/mxc_edid.h     |  1 +
 3 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/drivers/video/mxc/mxc_edid.c b/drivers/video/mxc/mxc_edid.c
index 88b5268..78cef96 100644
--- a/drivers/video/mxc/mxc_edid.c
+++ b/drivers/video/mxc/mxc_edid.c
@@ -720,6 +720,19 @@ int mxc_edid_mode_to_vic(const struct fb_videomode *mode)
 }
 EXPORT_SYMBOL(mxc_edid_mode_to_vic);
 
+int mxc_edid_mode_to_vesa(const struct fb_videomode *mode)
+{
+	int i;
+	bool use_aspect = (mode->vmode & FB_VMODE_ASPECT_MASK);
+
+	for (i = 0; i < VESA_MODEDB_SIZE; i++) {
+		if (mxc_edid_fb_mode_is_equal(use_aspect, mode, &vesa_modes[i]))
+			return i;
+	}
+	return 0;
+}
+EXPORT_SYMBOL(mxc_edid_mode_to_vesa);
+
 /* make sure edid has 512 bytes*/
 int mxc_edid_read(struct i2c_adapter *adp, unsigned short addr,
 	unsigned char *edid, struct mxc_edid_cfg *cfg, struct fb_info *fbi)
diff --git a/drivers/video/mxc/mxc_hdmi.c b/drivers/video/mxc/mxc_hdmi.c
index 8ea7d0d..cd29910 100644
--- a/drivers/video/mxc/mxc_hdmi.c
+++ b/drivers/video/mxc/mxc_hdmi.c
@@ -1803,7 +1803,7 @@ static void mxc_hdmi_edid_rebuild_modelist(struct mxc_hdmi *hdmi)
 		mode = &hdmi->fbi->monspecs.modedb[i];
 
 		if (!(mode->vmode & FB_VMODE_INTERLACED) &&
-				(mxc_edid_mode_to_vic(mode) != 0)) {
+				(mxc_edid_mode_to_vic(mode) != 0 || mxc_edid_mode_to_vesa(mode) != 0)) {
 
 			dev_dbg(&hdmi->pdev->dev, "Added mode %d:", i);
 			dev_dbg(&hdmi->pdev->dev,
diff --git a/include/video/mxc_edid.h b/include/video/mxc_edid.h
index 34e797c..6824db93 100755
--- a/include/video/mxc_edid.h
+++ b/include/video/mxc_edid.h
@@ -98,6 +98,7 @@ struct mxc_edid_cfg {
 
 int mxc_edid_var_to_vic(struct fb_var_screeninfo *var);
 int mxc_edid_mode_to_vic(const struct fb_videomode *mode);
+int mxc_edid_mode_to_vesa(const struct fb_videomode *mode);
 int mxc_edid_read(struct i2c_adapter *adp, unsigned short addr,
 	unsigned char *edid, struct mxc_edid_cfg *cfg, struct fb_info *fbi);
 int mxc_edid_parse_ext_blk(unsigned char *edid, struct mxc_edid_cfg *cfg,
-- 
1.8.3.1

